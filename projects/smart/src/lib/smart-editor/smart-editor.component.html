<ng-template #errorTip let-control>
    <ng-container *ngIf="control.hasError('required')">必填项</ng-container>
    <ng-container *ngIf="control.hasError('pattern')">格式不对</ng-container>
    <ng-container *ngIf="control.hasError('min')">太小了</ng-container>
    <ng-container *ngIf="control.hasError('max')">太大了</ng-container>
    <ng-container *ngIf="control.hasError('minlength')">太短了</ng-container>
    <ng-container *ngIf="control.hasError('maxlength')">太长了</ng-container>
</ng-template>


<!-- 表单模板 -->
<ng-template #controlTpl let-field let-control>
    @switch (field.type) {
        @case ('text') {
            <input nz-input [formControl]="control">
        }
        @case ('object') {
            <ng-container *ngTemplateOutlet="groupTpl; context: { fields: field.children, group:control }">
            </ng-container>
        }
        @case ('table') {
            <!--表格-->
            <nz-table nzSize="small" nzTemplateMode>
                <!--表头-->
                <tr>
                    @for (f of field.children;let j=$index;track f) {
                        <th>{{ f.label }}</th>
                    }
                </tr>

                <!--内容-->
                @for (c of control.controls;let i=$index;track c) {
                    <!--行-->
                    <tr>
                        @for (f of field.children;let j=$index;track f) {
                            <td>
                                <ng-container
                                    *ngTemplateOutlet="groupTpl; context: { fields: field.children, group:c.get(f.key) }">
                                </ng-container>
                            </td>
                        }
                    </tr>
                }
            </nz-table>
        }
    }
</ng-template>

<!-- 表单组模板 -->
<ng-template #groupTpl let-fields let-group>
    @for (field of fields;track field) {
        <nz-form-item>
            <nz-form-label [nzSm]="6" [nzXs]="24"
                           [nzRequired]="field.required"
                           [nzFor]="field.key">{{ field.label }}
            </nz-form-label>
            <nz-form-control [nzSm]="14" [nzXs]="24" [nzErrorTip]="errorTip">
                <ng-container *ngTemplateOutlet="controlTpl; context: { field: field, group:group.get(field.key)}">
                </ng-container>
            </nz-form-control>
        </nz-form-item>
    }
</ng-template>


<form (ngSubmit)="onSubmit()">
    <ng-container *ngTemplateOutlet="groupTpl; context: { fields: fields, group: group }">
    </ng-container>
</form>


